function Chat(){this.update=updateChat;this.send=sendChat;this.getState=getStateOfChat}function getStateOfChat(){if(!instanse){instanse=true;$.ajax({type:"POST",url:"process.php",data:{"function":"getState",file:file,file_name:file_name,cookie:$.cookie("user_id")},dataType:"json",success:function(e){state=e.state;instanse=false}})}}function escapeSpecialChars(e){e=e.replace(/\\'/g,"'");e=e.toString().replace(/\\"/g,'"');e=e.replace(/\\\\/g,"\\");return e}function updateChat(){if(!instanse){instanse=true;$.ajax({type:"POST",url:"process.php",data:{"function":"update",state:state,file:file,file_name:file_name},dataType:"json",error:function(e){},success:function(e){if(e.text){if(e.end){showRatingBox(true);clearInterval(updateInterval)}else{for(var t=0;t<e.text.length;t++){var n=e.text[t].indexOf(" ");var r=e.text[t].indexOf(" ",n+1);var i=e.text[t].substring(0,n);var s=e.text[t].substring(n+1,r);var o=e.text[t].substring(r+1);o=escapeSpecialChars(o);var u="";if($.cookie("user_id")==s)u="You";else u="Stranger";$("#chat-area").append($("<p><span>"+u+"</span>"+o+"</p>"));$("title").html(o)}document.getElementById("chat-area").scrollTop=document.getElementById("chat-area").scrollHeight}}instanse=false;state=e.state}})}else{setTimeout(updateChat,300)}}function sendChat(e,t){updateChat();$.ajax({type:"POST",url:"process.php",data:{"function":"send",message:e,nickname:t,file:file,file_name:file_name},dataType:"json",success:function(e){updateChat()}})}function areUsersReady(){if(!usersReady){$.ajax({type:"POST",url:"process.php",data:{"function":"usersReady",file_name:file_name},dataType:"json",success:function(e){if(!usersReady&&e.ready){unlockChat();usersReady=true;clearInterval(usersReadyInterval);$("#chat-area").append($("<p>You have been connected!  Say 'hello' to your conversation partner.</p>"))}}})}}function GetURLParameter(e){var t=window.location.search.substring(1);var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]==e){return i[1]}}}function showRatingBox(e){if(e){var t="Your partner has disconnected.";$("#dialog-confirm-message").append(t)}var n="On a scale from 1-5, how meaningful was this conversation to you?";$("#dialog-confirm-message").append(n);$("#dialog-confirm").css("border-bottom","none");$("#dialog-confirm").dialog({resizable:false,height:100,modal:true,buttons:{"Rate and close":function(){var e=this;var t=$("#survey").serialize();if(t==""){alert("Please rate this conversation.");return}else{var n=t.substring(7);$.ajax({type:"POST",url:"rate.php",data:{chat_filename:file_name,rating:$.cookie("user_id")+": "+n},success:function(t){$.removeCookie("current_chatroom");hasRated=true;console.log("hasRated changed to "+hasRated);$(e).dialog("close");window.location="index.php"}})}}}});if(e){$(".ui-button-text-only").css("margin-top","70px")}}function lockChat(){$("#sendie").prop("disabled",true);$("#chat-area").css("background-color","#efefef");var e="<div id='wait-msg'>Please wait while we connect you with a partner :)</div>";e+="<div id='ballsWaveG'>";e+="<div id='ballsWaveG_1' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_2' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_3' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_4' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_5' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_6' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_7' class='ballsWaveG'></div>";e+="<div id='ballsWaveG_8' class='ballsWaveG'></div>";e+="</div>";$("#chat-area").html(e)}function unlockChat(){$("#sendie").prop("disabled",false);$("#chat-area").css("background-color","white");$("#chat-area").html("")}function confirmExit(){console.log("hasRated is "+hasRated);if(!hasRated){if(usersReady){$.ajax({type:"POST",url:"rate.php",data:{chat_filename:file_name,rating:$.cookie("user_id")+":  -1"},async:false,success:function(e){$.removeCookie("current_chatroom")}})}else{$.ajax({type:"POST",url:"clearroom.php",data:{current_chatroom:$.cookie("current_chatroom")},async:false,success:function(e){$.removeCookie("current_chatroom")}})}}}var instanse=false;var state;var mes;var file;var unique_id=GetURLParameter("id");var file_name="conversations/"+unique_id+".txt";var usersReady=false;var usersReadyInterval=setInterval(function(){areUsersReady()},1e3);var name="You";var hasRated=false;$("#name-area").html("");var chat=new Chat;$(function(){chat.getState();$("#sendie").keydown(function(e){var t=e.which;if(t>=33){var n=$(this).attr("maxlength");var r=this.value.length;if(r>=n){e.preventDefault()}}});$("#sendie").keyup(function(e){if(e.keyCode==13){var t=(new Date).getTime()+" "+$.cookie("user_id")+" "+$(this).val();var n=$(this).attr("maxlength");var r=t.length;if(r<=n+1){chat.send(t,name);$(this).val("")}else{$(this).val(t.substring(0,n))}}});$(".send-button").click(function(){var e=(new Date).getTime()+" "+$.cookie("user_id")+" "+$("#sendie").val();var t=$("#sendie").attr("maxlength");var n=e.length;if(n<=t+1){chat.send(e,name);$("#sendie").val("")}else{$("#sendie").val(e.substring(0,t))}});lockChat()});window.onbeforeunload=confirmExit;$("#end-convo").click(function(){if(!usersReady){$.ajax({type:"POST",url:"clearroom.php",data:{current_chatroom:$.cookie("current_chatroom")},success:function(e){$.removeCookie("current_chatroom");hasRated=true;window.location="index.php"}})}else{if(confirm("Are you sure you wish to end this conversation? There's no going back if you do.")){clearInterval(updateInterval);$.removeCookie("current_chatroom");hasRated=true;showRatingBox(false)}}})